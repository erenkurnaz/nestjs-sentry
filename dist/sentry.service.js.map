{"version":3,"file":"sentry.service.js","sourceRoot":"/","sources":["sentry.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { ConsoleLogger, Inject, Injectable, Logger, LoggerService } from '@nestjs/common';\nimport { OnApplicationShutdown } from '@nestjs/common';\nimport { Client } from '@sentry/types';\nimport * as Sentry from '@sentry/node';\nimport { SENTRY_MODULE_OPTIONS } from './sentry.tokens';\nimport { SentryModuleOptions } from './interfaces';\n\n@Injectable()\nexport class SentryService implements OnApplicationShutdown, LoggerService {\n  private static serviceInstance: SentryService;\n  constructor(\n    @Inject(SENTRY_MODULE_OPTIONS)\n    readonly options?: SentryModuleOptions,\n  ) {\n    if (!(options && options.dsn)) return;\n\n    const { integrations = [], logger, loggerOptions, ...sentryOptions } = options;\n    if (typeof logger === 'undefined') {\n      options.logger = new ConsoleLogger('SentryModule', loggerOptions || {});\n    }\n    Sentry.init({\n      ...sentryOptions,\n      integrations: [\n        new Sentry.Integrations.OnUncaughtException({\n          onFatalError: async (err) => {\n            if (this.options && this.options.logger && this.options.logger.fatal) {\n              this.options.logger.fatal(err);\n            }\n            if (err.name === 'SentryError') {\n              console.log(err);\n            } else {\n              Sentry.getCurrentHub().getClient<Client>().captureException(err);\n              process.exit(1);\n            }\n          },\n        }),\n        new Sentry.Integrations.OnUnhandledRejection({ mode: 'warn' }),\n        ...integrations,\n      ],\n    });\n  }\n\n  public static SentryServiceInstance(): SentryService {\n    if (!SentryService.serviceInstance) {\n      SentryService.serviceInstance = new SentryService();\n    }\n    return SentryService.serviceInstance;\n  }\n\n  log(message: string, context?: string, asBreadcrumb?: boolean) {\n    if (this.options.prefix) {\n      message = `${this.options.prefix}: ${message}`;\n    }\n    if (this.options && this.options.logger) {\n      this.options.logger.log(message, context);\n    }\n    try {\n      asBreadcrumb\n        ? Sentry.addBreadcrumb({\n            message,\n            level: 'log',\n            data: {\n              context,\n            },\n          })\n        : Sentry.captureMessage(message, 'log');\n    } catch (err) {\n      Logger.error(err, SentryService.name);\n    }\n  }\n\n  error(message: string, trace?: string, context?: string) {\n    if (this.options.prefix) {\n      message = `${this.options.prefix}: ${message}`;\n    }\n    try {\n      if (this.options && this.options.logger && this.options.logger.error) {\n        this.options.logger.error(message, trace, context);\n      }\n      Sentry.captureMessage(message, 'error');\n    } catch (err) {\n      Logger.error(err, SentryService.name);\n    }\n  }\n\n  warn(message: string, context?: string, asBreadcrumb?: boolean) {\n    if (this.options.prefix) {\n      message = `${this.options.prefix}: ${message}`;\n    }\n    try {\n      if (this.options && this.options.logger && this.options.logger.warn) {\n        this.options.logger.warn(message, context);\n      }\n      asBreadcrumb\n        ? Sentry.addBreadcrumb({\n            message,\n            level: 'warning',\n            data: {\n              context,\n            },\n          })\n        : Sentry.captureMessage(message, 'warning');\n    } catch (err) {\n      Logger.error(err, SentryService.name);\n    }\n  }\n\n  debug(message: string, context?: string, asBreadcrumb?: boolean) {\n    if (this.options.prefix) {\n      message = `${this.options.prefix}: ${message}`;\n    }\n    try {\n      if (this.options && this.options.logger && this.options.logger.debug) {\n        this.options.logger.debug(message, context);\n      }\n      asBreadcrumb\n        ? Sentry.addBreadcrumb({\n            message,\n            level: 'debug',\n            data: {\n              context,\n            },\n          })\n        : Sentry.captureMessage(message, 'debug');\n    } catch (err) {\n      Logger.error(err, SentryService.name);\n    }\n  }\n\n  verbose(message: string, context?: string, asBreadcrumb?: boolean) {\n    if (this.options.prefix) {\n      message = `${this.options.prefix}: ${message}`;\n    }\n    try {\n      if (this.options && this.options.logger && this.options.logger.verbose) {\n        this.options.logger.verbose(message, context);\n      }\n      asBreadcrumb\n        ? Sentry.addBreadcrumb({\n            message,\n            level: 'info',\n            data: {\n              context,\n            },\n          })\n        : Sentry.captureMessage(message, 'info');\n    } catch (err) {\n      Logger.error(err, SentryService.name);\n    }\n  }\n\n  instance() {\n    return Sentry;\n  }\n\n  async onApplicationShutdown(signal?: string) {\n    if (this.options?.close?.enabled === true) {\n      if (this.options && this.options.logger && this.options.logger.verbose && this.options.prefix) {\n        this.options.logger.log(`${this.options.prefix}: ${signal}`);\n      }\n      await Sentry.close(this.options?.close.timeout);\n    }\n  }\n}\n"]}